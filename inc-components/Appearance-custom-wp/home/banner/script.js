(function () {
  function init() {
    var hidden = document.getElementById("buildpro-banner-data");
    var wrapper = document.getElementById("buildpro-banner-wrapper");
    var addBtn = document.getElementById("buildpro-banner-add");
    if (!hidden || !wrapper || !addBtn) return;
    var frame;
    function write() {
      var rows = wrapper.querySelectorAll(".buildpro-banner-row");
      var data = [];
      rows.forEach(function (row) {
        var imageInput = row.querySelector("[data-field='image_id']");
        var obj = {
          image_id: 0,
          type: "",
          text: "",
          description: "",
          link_url: "",
          link_title: "",
          link_target: "",
        };
        obj.image_id =
          parseInt(imageInput && imageInput.value ? imageInput.value : 0, 10) ||
          0;
        var typeInput = row.querySelector("[data-field='type']");
        var textInput = row.querySelector("[data-field='text']");
        var descInput = row.querySelector("[data-field='description']");
        var urlInput = row.querySelector("[data-field='link_url']");
        var titleInput = row.querySelector("[data-field='link_title']");
        var targetSelect = row.querySelector("[data-field='link_target']");
        obj.type = typeInput && typeInput.value ? typeInput.value : "";
        obj.text = textInput && textInput.value ? textInput.value : "";
        obj.description = descInput && descInput.value ? descInput.value : "";
        obj.link_url = urlInput && urlInput.value ? urlInput.value : "";
        obj.link_title = titleInput && titleInput.value ? titleInput.value : "";
        obj.link_target =
          targetSelect && targetSelect.value ? targetSelect.value : "";
        data.push(obj);
      });
      hidden.value = JSON.stringify(data);
      hidden.dispatchEvent(new Event("change"));
    }
    function bindRow(row) {
      var selectBtn = row.querySelector(".select-banner-image");
      var removeImgBtn = row.querySelector(".remove-banner-image");
      var input = row.querySelector("[data-field='image_id']");
      var preview = row.querySelector(".banner-image-preview");
      var removeRowBtn = row.querySelector(".remove-banner-row");
      var linkBtn = row.querySelector(".choose-link");
      var panel = row.querySelector(".buildpro-link-panel");
      var searchInput = row.querySelector(".buildpro-link-search");
      var resultsBox = row.querySelector(".buildpro-link-results");
      var panelTargetToggle = row.querySelector(".buildpro-link-target");
      var closePanelBtn = row.querySelector(".buildpro-link-close");
      var typeInput = row.querySelector("[data-field='type']");
      var textInput = row.querySelector("[data-field='text']");
      var descInput = row.querySelector("[data-field='description']");
      var urlInput = row.querySelector("[data-field='link_url']");
      var titleInput = row.querySelector("[data-field='link_title']");
      var targetSelect = row.querySelector("[data-field='link_target']");
      function attachChange(el) {
        if (el) {
          el.addEventListener("input", write);
          el.addEventListener("change", write);
        }
      }
      attachChange(typeInput);
      attachChange(textInput);
      attachChange(descInput);
      attachChange(urlInput);
      attachChange(titleInput);
      attachChange(targetSelect);
      function showLinkPanel() {
        if (!panel) return;
        panel.style.display = "block";
        if (searchInput) {
          searchInput.focus();
        }
        performSearch("");
      }
      function hideLinkPanel() {
        if (!panel) return;
        panel.style.display = "none";
      }
      function renderResults(items) {
        if (!resultsBox) return;
        if (!items || !items.length) {
          resultsBox.innerHTML =
            "<p style='color:#888;margin:6px'>Không có kết quả</p>";
          return;
        }
        var html = items
          .map(function (it) {
            var title =
              it.title && it.title.rendered
                ? it.title.rendered
                : it.title || "";
            var url = it.url || it.link || "";
            return (
              "<button type='button' class='button button-secondary buildpro-link-result' data-url='" +
              (url || "") +
              "'>" +
              (title || url) +
              "</button>"
            );
          })
          .join(" ");
        resultsBox.innerHTML = html;
      }
      function performSearch(q) {
        var endpoint =
          "/wp-json/wp/v2/search?search=" +
          encodeURIComponent(q || "") +
          "&per_page=20";
        fetch(endpoint, { credentials: "same-origin" })
          .then(function (r) {
            return r.json();
          })
          .then(function (data) {
            var items = (data || []).map(function (d) {
              return { title: d.title, url: d.url };
            });
            renderResults(items);
          })
          .catch(function () {
            renderResults([]);
          });
      }
      if (searchInput) {
        var debounce;
        searchInput.addEventListener("input", function () {
          var q = searchInput.value || "";
          clearTimeout(debounce);
          debounce = setTimeout(function () {
            performSearch(q);
          }, 250);
        });
      }
      if (resultsBox) {
        resultsBox.addEventListener("click", function (e) {
          var t = e.target;
          if (
            t &&
            t.classList &&
            t.classList.contains("buildpro-link-result")
          ) {
            var url = t.getAttribute("data-url") || "";
            if (urlInput) {
              urlInput.value = url;
            }
            if (titleInput) {
              titleInput.value = t.textContent || "";
            }
            if (targetSelect && panelTargetToggle) {
              targetSelect.value = panelTargetToggle.checked ? "_blank" : "";
            }
            write();
            hideLinkPanel();
          }
        });
      }
      if (closePanelBtn) {
        closePanelBtn.addEventListener("click", function (e) {
          e.preventDefault();
          hideLinkPanel();
        });
      }
      function goToLinkPicker() {
        window.buildproLinkTarget = {
          urlInput: urlInput,
          titleInput: titleInput,
          targetSelect: targetSelect,
        };
        if (
          window.wp &&
          wp.customize &&
          typeof wp.customize.section === "function"
        ) {
          var s = wp.customize.section("buildpro_link_picker_section");
          if (s && typeof s.expand === "function") {
            s.expand();
            return;
          }
        }
        showLinkPanel();
      }
      if (selectBtn) {
        selectBtn.addEventListener("click", function (e) {
          e.preventDefault();
          if (!frame) {
            frame = wp.media({
              title: "Chọn ảnh",
              button: { text: "Sử dụng ảnh" },
              multiple: false,
            });
          }
          if (typeof frame.off === "function") {
            frame.off("select");
          }
          frame.on("select", function () {
            var attachment = frame.state().get("selection").first().toJSON();
            input.value = attachment.id;
            var url =
              attachment.sizes && attachment.sizes.thumbnail
                ? attachment.sizes.thumbnail.url
                : attachment.url;
            preview.innerHTML =
              "<img src='" + url + "' style='max-height:80px;'>";
            write();
          });
          frame.open();
        });
      }
      if (removeImgBtn) {
        removeImgBtn.addEventListener("click", function (e) {
          e.preventDefault();
          input.value = "";
          preview.innerHTML = "";
          write();
        });
      }
      if (linkBtn) {
        linkBtn.addEventListener("click", function (e) {
          e.preventDefault();
          goToLinkPicker();
        });
      }
      if (urlInput) {
        urlInput.addEventListener("click", function (e) {
          e.preventDefault();
          goToLinkPicker();
        });
      }
      if (removeRowBtn) {
        removeRowBtn.addEventListener("click", function (e) {
          e.preventDefault();
          row.parentNode.removeChild(row);
          write();
        });
      }
    }
    Array.prototype.forEach.call(
      wrapper.querySelectorAll(".buildpro-banner-row"),
      bindRow,
    );
    addBtn.addEventListener("click", function (e) {
      e.preventDefault();
      var idx = wrapper.querySelectorAll(".buildpro-banner-row").length;
      var html =
        "" +
        '<div class="buildpro-banner-row" data-index="' +
        idx +
        '">' +
        '  <div class="buildpro-banner-grid">' +
        '    <div class="buildpro-banner-block">' +
        "      <h4>Hình ảnh</h4>" +
        '      <div class="buildpro-banner-field">' +
        '        <input type="hidden" class="banner-image-id" data-field="image_id" value="">' +
        '        <button type="button" class="button select-banner-image">Chọn ảnh</button>' +
        '        <button type="button" class="button remove-banner-image">Xóa ảnh</button>' +
        "      </div>" +
        '      <div class="banner-image-preview" style="margin-top:8px;min-height:84px;display:flex;align-items:center;justify-content:center;background:#fff;border:1px dashed #ddd;border-radius:6px"><span style="color:#888">Chưa chọn ảnh</span></div>' +
        "    </div>" +
        '    <div class="buildpro-banner-block">' +
        "      <h4>Nội dung</h4>" +
        '      <p class="buildpro-banner-field"><label>Type</label><input type="text" class="regular-text" data-field="type" value=""></p>' +
        '      <p class="buildpro-banner-field"><label>Text</label><input type="text" class="regular-text" data-field="text" value=""></p>' +
        '      <p class="buildpro-banner-field"><label>Mô tả</label><textarea rows="4" class="large-text" data-field="description"></textarea></p>' +
        "      <h4>Liên kết</h4>" +
        '      <p class="buildpro-banner-field"><label>Link URL</label><input type="url" class="regular-text" data-field="link_url" value="" placeholder="https://..."> <button type="button" class="button choose-link">Chọn link</button></p>' +
        '      <p class="buildpro-banner-field"><label>Link Target</label><select data-field="link_target"><option value="">Mặc định</option><option value="_blank">Mở tab mới</option></select></p>' +
        "    </div>" +
        "  </div>" +
        '  <div class="buildpro-banner-actions"><button type="button" class="button remove-banner-row">Xóa mục</button></div>' +
        "</div>";
      var temp = document.createElement("div");
      temp.innerHTML = html;
      var row = temp.firstElementChild;
      wrapper.appendChild(row);
      bindRow(row);
      write();
    });
    write();
  }
  function onReady() {
    init();
  }
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", onReady);
  } else {
    onReady();
  }
  if (window.wp && wp.customize && typeof wp.customize.section === "function") {
    var s = wp.customize.section("buildpro_banner_section");
    if (s && s.expanded) {
      s.expanded.bind(function (exp) {
        if (exp) {
          setTimeout(init, 50);
        }
      });
    }
  }
  var obs = new MutationObserver(function () {
    if (document.getElementById("buildpro-banner-wrapper")) {
      init();
      obs.disconnect();
    }
  });
  if (document.body) {
    obs.observe(document.body, { childList: true, subtree: true });
  }
})();
